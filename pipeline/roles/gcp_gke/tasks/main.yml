- name: Check if Kubernetes Engine API is enabled
  ansible.builtin.command:
    cmd: gcloud services list --enabled --filter="container.googleapis.com" --format="value(config.name)"
  register: gke_api_status
  failed_when: false

- name: Enable Kubernetes Engine API
  ansible.builtin.command:
    cmd: gcloud services enable container.googleapis.com
  when: gke_api_status.stdout.strip() == ""
  register: enable_gke_api
  changed_when: enable_gke_api.rc == 0

- name: Ensure GKE cluster exists
  ansible.builtin.command:
    cmd: gcloud container clusters describe {{ gke_cluster_name }} --region {{ gke_cluster_region }}
  register: gke_cluster
  failed_when: false

- name: Create GKE cluster if it doesn't exist
  ansible.builtin.command:
    cmd: gcloud container clusters create {{ gke_cluster_name }} --region {{ gke_cluster_region }} --num-nodes 1 --machine-type e2-medium
  when: gke_cluster.rc != 0

- name: Get GKE credentials for kubectl access
  ansible.builtin.command:
    cmd: gcloud container clusters get-credentials {{ gke_cluster_name }} --region {{ gke_cluster_region }}